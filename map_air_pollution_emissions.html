<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Air Pollution Emissions Map</title>
    <style type="text/css">
      @import url("https://netdna.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css");

      .highcharts-figure .highcharts-data-table table {
        min-width: 360px;
        max-width: 800px;
        margin: 1em auto;
      }

      .highcharts-data-table table {
        font-family: Verdana, sans-serif;
        border-collapse: collapse;
        border: 1px solid #ebebeb;
        margin: 10px auto;
        text-align: center;
        width: 100%;
        max-width: 500px;
      }

      .highcharts-data-table caption {
        padding: 1em 0;
        font-size: 1.2em;
        color: #555;
      }

      .highcharts-data-table th {
        font-weight: 600;
        padding: 0.5em;
      }

      .highcharts-data-table td,
      .highcharts-data-table th,
      .highcharts-data-table caption {
        padding: 0.5em;
      }

      .highcharts-data-table thead tr,
      .highcharts-data-table tr:nth-child(even) {
        background: #f8f8f8;
      }

      .highcharts-data-table tr:hover {
        background: #f1f7ff;
      }

      #play-controls {
        max-width: 1000px;
        margin: 1em auto;
      }

      #container {
        height: 1200px;
        max-width: 1000px;
        margin: 0 auto;
      }

      #play-pause-button {
        margin-left: 10px;
        width: 50px;
        height: 50px;
        cursor: pointer;
        border: 1px solid rgba(2, 117, 255, 1);
        border-radius: 25px;
        color: white;
        background-color: rgba(2, 117, 255, 1);
        transition: background-color 250ms;
      }

      #play-pause-button:hover {
        background-color: rgba(2, 117, 255, 0.5);
      }

      #play-range {
        transform: translateY(2.5px);
        width: calc(100% - 90px);
        background: #f8f8f8;
      }
    </style>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.6/proj4.js"></script>
    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <script src="https://code.highcharts.com/maps/modules/data.js"></script>
    <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/maps/modules/offline-exporting.js"></script>
    <script src="https://code.highcharts.com/maps/modules/accessibility.js"></script>

    <figure class="highcharts-figure">
      <div id="parent-container">
        <div id="play-controls">
          <button
            id="play-pause-button"
            class="fa fa-play"
            title="play"
          ></button>
          <input
            id="play-range"
            type="range"
            value="1999"
            min="1999"
            max="2020"
          />
        </div>
        <div id="container"></div>
      </div>
      <p class="highcharts-description">
        Bar chart showing the world population by countries from 1960 to 2018.
      </p>
    </figure>

    <script type="text/javascript">
      const startYear = 1999,
        endYear = 2020,
        btn = document.getElementById("play-pause-button"),
        input = document.getElementById("play-range");

      let dataset, chart;

      // data and map.
      const koreaSidoMapInfo = [
        {
          "hc-key": "kr-kg",
          koreanName: "경기도",
          "hc-middle-lon": 127.231,
          "hc-middle-lat": 37.254,
        },
        {
          "hc-key": "kr-cb",
          koreanName: "전라북도",
          "hc-middle-lon": 127.104,
          "hc-middle-lat": 35.693,
        },
        {
          "hc-key": "kr-kn",
          koreanName: "경상남도",
          "hc-middle-lon": 128.192,
          "hc-middle-lat": 35.301,
        },
        {
          "hc-key": "kr-2685",
          koreanName: "전라남도",
          "hc-middle-lon": 127.038,
          "hc-middle-lat": 34.979,
        },
        {
          "hc-key": "kr-pu",
          koreanName: "부산광역시",
          "hc-middle-lon": 129.172,
          "hc-middle-lat": 35.173,
        },
        {
          "hc-key": "kr-2688",
          koreanName: "경상북도",
          "hc-middle-lon": 128.784,
          "hc-middle-lat": 36.2,
        },
        {
          "hc-key": "kr-sj",
          koreanName: "세종특별자치시",
          "hc-middle-lon": 127.21,
          "hc-middle-lat": 36.51,
        },
        {
          "hc-key": "kr-tj",
          koreanName: "대전광역시",
          "hc-middle-lon": 127.372,
          "hc-middle-lat": 36.372,
        },
        {
          "hc-key": "kr-ul",
          koreanName: "울산광역시",
          "hc-middle-lon": 129.218,
          "hc-middle-lat": 35.521,
        },
        {
          "hc-key": "kr-in",
          koreanName: "인천광역시",
          "hc-middle-lon": 126.629,
          "hc-middle-lat": 37.458,
        },
        {
          "hc-key": "kr-kw",
          koreanName: "강원도",
          "hc-middle-lon": 128.355,
          "hc-middle-lat": 37.678,
        },
        {
          "hc-key": "kr-gn",
          koreanName: "충청남도",
          "hc-middle-lon": 126.829,
          "hc-middle-lat": 36.538,
        },
        {
          "hc-key": "kr-cj",
          koreanName: "제주특별자치도",
          "hc-middle-lon": 126.557,
          "hc-middle-lat": 33.383,
        },
        {
          "hc-key": "kr-gb",
          koreanName: "충청북도",
          "hc-middle-lon": 127.783,
          "hc-middle-lat": 36.832,
        },
        {
          "hc-key": "kr-so",
          koreanName: "서울특별시",
          "hc-middle-lon": 127.005,
          "hc-middle-lat": 37.532,
        },
        {
          "hc-key": "kr-tg",
          koreanName: "대구광역시",
          "hc-middle-lon": 128.615,
          "hc-middle-lat": 35.891,
        },
        {
          "hc-key": "kr-kj",
          koreanName: "광주광역시",
          "hc-middle-lon": 126.913,
          "hc-middle-lat": 35.209,
        },
      ];

      /*
       * transform csv to json
       */
      function csvToArray(csv) {
        const lines = csv.split("\n");
        const headers = lines[0].split(",");
        const result = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].replace(/\r/g, "");
          const currentLine = line.split(",");
          if (currentLine.length === headers.length) {
            const obj = {};
            for (let j = 0; j < headers.length; j++) {
              obj[headers[j].replace(/\r/g, "")] = currentLine[j];
            }
            result.push(obj);
          }
        }

        return result;
      }

      function getData(year) {
        const output = dataset[year].map((value, index) => {
          return {
            name: dataset["name"][index],
            z: Number(value),
            lat: koreaSidoMapInfo.filter(
              (info) => info.koreanName === dataset["name"][index]
            )[0]["hc-middle-lat"],
            lon: koreaSidoMapInfo.filter(
              (info) => info.koreanName === dataset["name"][index]
            )[0]["hc-middle-lon"],
          };
        });
        return output;
      }

      /**
       * transpose json
       */
      function transposeData(data) {
        const transposedData = {};

        data.forEach((row) => {
          for (const [key, value] of Object.entries(row)) {
            if (!transposedData[key]) {
              transposedData[key] = [];
            }
            transposedData[key].push(value);
          }
        });

        return transposedData;
      }

      (async () => {
        const topology = await fetch(
          "https://code.highcharts.com/mapdata/countries/kr/kr-all.topo.json"
        ).then((response) => response.json());

        dataset = await fetch(
          "https://raw.githubusercontent.com/researcher-jh/kei-high-chart/main/data/air_pollution_emissions.csv"
        )
          .then((response) => response.text())
          .then((response) => csvToArray(response))
          .then((response) => transposeData(response));

        console.log(dataset);
        const H = Highcharts;

        chart = Highcharts.mapChart("container", {
          title: {
            text: "Highcharts Maps lon/lat demo",
          },
          tooltip: {
            pointFormat:
              "{point.name}: <br>" +
              // "Lon: {point.lon}<br>" +
              // "Lat: {point.lat}<br>" +
              "{point.z}",
          },
          xAxis: {
            crosshair: {
              zIndex: 5,
              dashStyle: "dot",
              snap: false,
              color: "gray",
            },
          },
          yAxis: {
            crosshair: {
              zIndex: 5,
              dashStyle: "dot",
              snap: false,
              color: "gray",
            },
          },
          plotOptions: {
            series: {
              marker: {
                radius: 100,
              },
            },
          },
          series: [
            {
              name: "South Korea Air Pollution emissions",
              mapData: topology,
              // accessibility: {
              //   exposeAsGroupOnly: true,
              // },
              borderColor: "#606060",
              nullColor: "rgba(200, 200, 200, 0.2)",
              showInLegend: false,
            },
            {
              name: "Air Pollation Emissions",
              type: "mapbubble", //"mappoint",
              dataLabels: {
                enabled: true,
                format: "{point.name}",
              },
              accessibility: {
                point: {
                  valueDescriptionFormat:
                    "{point.name}, Population {point.population}. Latitude {point.lat:.2f}, longitude {point.lon:.2f}.",
                },
              },
              data: getData(startYear),
              maxSize: "12%",
              color: H.getOptions().colors[0],
            },
          ],
        });

        //Display custom label with lat/lon next to crosshairs
        document
          .getElementById("container")
          .addEventListener("mousemove", (e) => {
            if (!chart.lbl) {
              chart.lbl = chart.renderer
                .text("", 0, 0)
                .attr({
                  zIndex: 5,
                })
                .css({
                  color: "#505050",
                })
                .add();
            }

            e = chart.pointer.normalize(e);

            chart.lbl.attr({
              x: e.chartX + 5,
              y: e.chartY - 22,
              text: "Lat: " + e.lat.toFixed(2) + "<br>Lon: " + e.lon.toFixed(2),
            });
          });
      })();

      /*
       * Pause the timeline, either when the range is ended, or when clicking the pause button.
       * Pausing stops the timer and resets the button to play mode.
       */
      function pause(button) {
        button.title = "play";
        button.className = "fa fa-play";
        clearTimeout(chart.sequenceTimer);
        chart.sequenceTimer = undefined;
      }

      /*
       * Update the chart. This happens either on updating (moving) the range input,
       * or from a timer when the timeline is playing.
       */
      function update(increment) {
        if (increment) {
          input.value = parseInt(input.value, 10) + increment;
        }
        if (input.value >= endYear) {
          // Auto-pause
          pause(btn);
        }

        // chart.update(
        //   {
        //     // subtitle: {
        //     //   text: getSubtitle(),
        //     // },
        //   },
        //   false,
        //   false,
        //   false
        // );

        chart.series[1].update({
          name: input.value,
          data: getData(input.value),
        });
      }

      /*
       * Play the timeline.
       */
      function play(button) {
        button.title = "pause";
        button.className = "fa fa-pause";
        chart.sequenceTimer = setInterval(function () {
          update(1);
        }, 500);
      }

      btn.addEventListener("click", function () {
        if (chart.sequenceTimer) {
          pause(this);
        } else {
          play(this);
        }
      });
      /*
       * Trigger the update on the range bar click.
       */
      input.addEventListener("input", function () {
        update();
      });
    </script>
  </body>
</html>
